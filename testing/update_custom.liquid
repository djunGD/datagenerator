{%-assign out_prefix = "out_generated_" -%}

CREATE OR REPLACE FUNCTION randomcustomdata(values VARCHAR) RETURN VARCHAR
AS
BEGIN
   RETURN 	
   	CASE 
		WHEN values LIKE '%,%' THEN TRIM(SPLIT_PART(values,',', (FLOOR(RANDOM() * (REGEXP_COUNT(values,',') + 1) + 1 ))::INT))
		WHEN values LIKE '%-%' THEN randomfact(SPLIT_PART(values,'-',1)::INT, SPLIT_PART(values,'-',2)::INT)::VARCHAR
	END;
END;

---------------------------------------------------------------------
---> Updating {{out_prefix}} tables with custom values 
---------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS csv_custom_values
(
	dataset VARCHAR,
	type VARCHAR,
	field VARCHAR,
	values VARCHAR
);

CREATE OR REPLACE VIEW wrk_generated_custom_values AS 
	SELECT 
		LOWER(dataset) as dataset,
		type,
		LOWER(REGEXP_REPLACE(REPLACE(field,' ',''),'(\d)','')) as field,
		values
	FROM csv_custom_values	
;

{% for dataset in model.projectModel.datasets -%}
{% assign dataset_name = {{dataset.dataset.identifier | remove: "dataset." }} %}


---- Updating {{out_prefix}}{{dataset_name}} ----
{{}}
{%- if anchor_first_attribute_factsof[2] != "factsof"  -%}  
    {% for label in dataset.dataset.anchor.attribute.labels %}
        {%- assign current_label = {{label.label.identifier}} -%}
        {% assign label_split = {{current_label | split: "."}} %}
UPDATE {{out_prefix}}{{dataset_name}} t SET {{label_split[-1]}} = randomcustomdata(c.values) 
FROM wrk_generated_custom_values c WHERE c.dataset = '{{dataset_name}}' AND c.field = '{{label_split[-1]}}';      
    {% endfor %}
{%- endif -%}  
{{}}      
{%- for attribute in dataset.dataset.attributes -%}
    {% for label in attribute.attribute.labels %}
        {%- assign current_label = {{label.label.identifier}} -%}
        {% assign label_split = {{current_label | split: "."}} %}
UPDATE {{out_prefix}}{{dataset_name}} t SET {{label_split[-1]}} = randomcustomdata(c.values) 
FROM wrk_generated_custom_values c WHERE c.dataset = '{{dataset_name}}' AND c.field = '{{label_split[-1]}}';               
    {% endfor %}    
{%- endfor -%}  
    
{%- for fact in dataset.dataset.facts -%}
    {% assign fact_split = {{fact.fact.identifier | split: "."}} %}  
UPDATE {{out_prefix}}{{dataset_name}} t SET {{fact_split[-1]}} = randomcustomdata(c.values)::{{fact.fact.dataType}} 
FROM wrk_generated_custom_values c WHERE c.dataset = '{{dataset_name}}' AND c.field = '{{fact_split[-1]}}';  
{{}}                
{%- endfor -%}    
      

{%- endfor -%}

