-----------------------------
--- Dropping out tables  ----
----------------------------- 
{%- for dataset in model.projectModel.datasets %}
DROP TABLE IF EXISTS out_{{dataset.dataset.identifier | remove: "dataset." }};
{%- endfor %}

-----------------------------
--- Dropping out views   ----
----------------------------- 
{%- for dataset in model.projectModel.datasets %}
DROP VIEW IF EXISTS out_vw_{{dataset.dataset.identifier | remove: "dataset." }};
{%- endfor %}


{% comment %} TODO formatting sucks{% endcomment %}

------------------------------
---- Creating out_ tables ----
------------------------------
{% for dataset in model.projectModel.datasets %}
{% assign dataset_name = {{dataset.dataset.identifier | remove: "dataset." }} %}


CREATE TABLE IF NOT EXISTS out_{{dataset_name}} (
    {% comment %} "cp__" has one? condition: first anchor attribute is not factof. Can this be ultimately checked from identifier? {% endcomment %}	
    {%- assign anchor_first_attribute_factsof = {{dataset.dataset.anchor.attribute.identifier | split: "."}} -%}							
    {%- if anchor_first_attribute_factsof[2] != "factsof"  -%}	
        {%- assign is_cp = true -%}
        {%- assign default_label = {{dataset.dataset.anchor.attribute.defaultLabel}} -%}
        {%- for label in dataset.dataset.anchor.attribute.labels -%}
            {%- assign current_label = {{label.label.identifier}} -%}
            {%- assign label_split = {{current_label | split: "."}} -%}
            {{label_split[-1]}} {{label.label.dataType}}
        {%- unless forloop.last -%},
        {% endunless -%}            
        {%- endfor -%}
    {%- if dataset.dataset.attributes -%},{%- endif %}      
    {% endif -%}
    {% comment %} attributes {% endcomment %}	      
    {%- for attribute in dataset.dataset.attributes -%}
        {%- assign default_label = {{attribute.attribute.defaultLabel}} -%}
        {%- for label in attribute.attribute.labels -%}
            {%- assign current_label = {{label.label.identifier}} -%}
            {%- assign label_split = {{current_label | split: "."}} -%}
            {{label_split[-1]}} {{label.label.dataType}}
        {%- unless forloop.last -%},
        {% endunless -%}            
        {%- endfor -%}    
    {%- unless forloop.last -%},
    {% endunless -%}               
    {%- endfor -%}  
    {% comment %} references {% endcomment %}
    {%- if dataset.dataset.references -%},{% endif %}    
    {% for reference in dataset.dataset.references %}
        {% comment %} TODO collect the types of cps prior{% endcomment %}
        {%- assign reference_split = {{reference | split: "."}} -%}
        {%- if reference_split[0] == "dataset" %}{{reference_split[1]}} VARCHAR(128)
        {%- else %}{{reference}} DATE
        {%- endif -%}
    {%- unless forloop.last -%},
    {% endunless -%}               
    {%- endfor -%}     
    {% comment %} facts {% endcomment %}
    {%- if dataset.dataset.facts -%},{% endif %}    
    {% for fact in dataset.dataset.facts %}
            {%- assign fact_split = {{fact.fact.identifier | split: "."}} -%}
            {{fact_split[-1]}} {{fact.fact.dataType}}              
    {%- unless forloop.last -%},
    {% endunless -%}               
    {%- endfor %}      
);
{%- endfor -%}



-------------------------------
---- Creating out_vw_views ----
-------------------------------
{% for dataset in model.projectModel.datasets %}
{% assign dataset_name = {{dataset.dataset.identifier | remove: "dataset." }} %}

CREATE VIEW IF NOT EXISTS out_vw_{{dataset_name}} AS
SELECT
    {% comment %} "cp__" has one? condition: first anchor attribute is not factof. Can this be ultimately checked from identifier? {% endcomment %}	
    {%- assign anchor_first_attribute_factsof = {{dataset.dataset.anchor.attribute.identifier | split: "."}} -%}							
    {%- if anchor_first_attribute_factsof[2] != "factsof"  -%}	
        {%- assign is_cp = true -%}
        {%- assign default_label = {{dataset.dataset.anchor.attribute.defaultLabel}} -%}
        {%- for label in dataset.dataset.anchor.attribute.labels -%}
            {%- assign current_label = {{label.label.identifier}} -%}
            {%- assign label_split = {{current_label | split: "."}} -%}
            {{label_split[-1]}} AS 
            {%- if {{current_label == default_label  %} cp
                {%- for part in label_split -%}
                    {%- if part != label_split[0] -%}
                    __{{ part }}
                    {%- endif -%}   
                {%- endfor -%}                
           {%- else %} l
                {%- for part in label_split -%}
                    {%- if part != label_split[0] -%}
                    __{{ part }}
                    {%- endif -%}
                {%- endfor -%}                 
            {%- endif -%}
        {%- unless forloop.last -%},
        {% endunless -%}            
        {%- endfor -%}
    {%- if dataset.dataset.attributes -%},{%- endif %}      
    {% endif -%}
    {% comment %} attributes {% endcomment %}	      
    {%- for attribute in dataset.dataset.attributes -%}
        {%- assign default_label = {{attribute.attribute.defaultLabel}} -%}
        {%- for label in attribute.attribute.labels -%}
            {%- assign current_label = {{label.label.identifier}} -%}
            {%- assign label_split = {{current_label | split: "."}} -%}
            {{label_split[-1]}} AS 
            {%- if {{current_label == default_label %} a__{{label_split[-1]}}
            {% comment %} TODO how to check nil value?? {% endcomment %}	    
            {%- elsif {{default_label == empty %} a__{{label_split[-1]}}
            {%- else %} l
                {%- for part in label_split -%}
                    {%- if part != label_split[0] and part != label_split[1] -%}
                    __{{ part }}
                    {%- endif -%}
                {%- endfor -%}                 
            {%- endif %}
        {%- unless forloop.last -%},
        {%- endunless -%}            
        {%- endfor -%}    
    {%- unless forloop.last -%},
    {%- endunless -%}               
    {%- endfor -%}  
    {% comment %} references {% endcomment %}
    {%- if dataset.dataset.references -%},{% endif %}    
    {% for reference in dataset.dataset.references %}
        {%- assign reference_split = {{reference | split: "."}} -%}
        {%- if reference_split[0] == "dataset" %}{{reference_split[1]}} AS r__{{reference_split[1]}}
        {%- else %}{{reference}} AS r__{{reference}}
        {%- endif -%}
    {%- unless forloop.last -%},
    {% endunless -%}               
    {%- endfor -%}     
    {% comment %} facts {% endcomment %}
    {%- if dataset.dataset.facts -%},{% endif %}    
    {% for fact in dataset.dataset.facts %}
            {%- assign fact_split = {{fact.fact.identifier | split: "."}} -%}
            {{fact_split[-1]}} AS f
                {%- for part in fact_split -%}
                    {%- if part != fact_split[0] -%}
                    __{{ part }}
                    {%- endif -%}
                {%- endfor -%}                  
    {%- unless forloop.last -%},
    {% endunless -%}               
    {%- endfor %}      
FROM out_{{dataset_name}}
;
{%- endfor -%}

